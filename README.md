# human-detector

Опрашиваает COM port, подключенный через USB Digispark Attiny85.

Рабтает с заданной задержкой (в 1 или 2 секунды). 

В течение временого окна выделяет максимальную температуру, и, если
температура находится в заданном диапазоне, выдает ее в stdout.

[Репозиторий irthermometer](https://gitlab.com/commandus/irthermometer.git)

[Репозиторий human-detector](https://gitlab.com/commandus/humandetector.git)

## Схема передачи данных с датчика

Контроллер USB Digispark Attiny85 имеет загрузчик, который при подключении к USB порту в
течение 5 секунд ожидает подключения программатора, устанавливаемого в Arduino IDE.

По истечении 5 секунд он передает управление загруженному в контроллер коду. При этом меняется описание устройства.

Поэтому при подключении к USB порту нужно ждать 5 секунд.

В Windows нужно устанавливать драйвер. В Linux, в часности, в Ubuntu, нужно прописывать правила USB.

Программа может послать один из трех символов в COM порт:

- '0' запрос температуры ИК датчика
- '1' запрос температуры окружающей среды (корпуса датчика)
- '2' запрос числа тиков. Используется для отладки

При любом запросе включаестя или выключается второй светодиод. Первый светодиод постоянно горит при полдключении к USB порту.

В ответ по COM порту приходит температура (или тики).

Температура в Кельвинах, значение умножено на 100.

Загрузка кода делается из Ardiuno IDE.

У меня где-то в KDE иногда начинает возникать ошибка при подключении USB Digispark Attiny85, при этом устройство ошибочно определяется как ISDN модем.

Пример кода Digispark, как отправлять данные по COM порту, часто приводит к зависанию где то в KDE- вероятно, нужно разобраться с правильностью определения USB устройства.

```
    +---------------------+  32-42C  +--------+ 
    |    human-detector   |--------->| Max T  |
    +---------------------+    1s    +--------+
           | 
           | USB serial port
           |
    +--------------+
    |   Digispark  |
    |   AtTiny85   |
    +--------------+
           |
           |                           ИК термометр
    +---------------+               +------------------+
    |   I2C bus     | <-------------| Melexis MLX90614 | 
    +---------------+               +------------------+
```

## Принцип работы

Задается границы минимальной и максимвльной температуры тела. За этими пределами считается, что данные не считываются.

Задается временной промежуток времени, по умолчанию равный 1 секунде, в течение которого делаются измерения температуры тела.

Началом измерения считается время, когда значение температуры стало находиться в заданном диапазоне.

Окончанием измерения считается время, когда значение температуры вышло за пределы диапазона.

Определяется максимальное значение и передается в stdout с меткой времени начала измерения.

Если измерения продолжаются больше секунды, каждую секунду (или через другой заданный промежуток времени) отправляется новое значение максимальной температуры с той же самой меткой времени.

За 1 секунду по COM порту контроллер способен передать не более 20-25 значений температуры.

## Опции

- путь устройства COM порта
- -l Число ожидаемой минимальной температуры тела в градусаз Цельсия. По умолчанию 32
- -h Число ожидаемой максимальной температуры тела в градусаз Цельсия. По умолчанию 42
- -s Число секунд временного окна. По умолчанию 1 секунда. В течение заданного промежутака времени определяется максимальная температура.
- -g K- выдает температуру в градусах Цельсия. C- в Кельвинах (по умолчанию). Градус Цельсия = K + 273.15
- -y Число миллисекунд задержки между чтениями COM порта. По умолчанию нет.


```
./human-detector -?
Usage: human-detector
 [-v?] [COM port path] [-l <number>] [-h <number>] [-s <number>] [-g K or C] [-y <ms>]
Temperature reader
  COM port path             Default /dev/ttyACM0
  -l, --t0=<number>         lo temperature threshold, C. Default 32
  -h, --t1=<number>         hi temperature threshold, C. Default 42
  -s, --seconds=<number>    Default 1
  -g, --degrees=K or C      K- Kelvin (default), C- Celcius
  -y, --delay=<ms>          delay to read, C. Default 0
  -v, --verbose             Set verbosity level
  -?, --help                Show this help
```

## Зависимости

- libev

```
sudo apt install libev-dev
```

### Linux

```
./autogen.sh 
./configure
make
sudo make install
```

### Windows

```
mkdir build
cd build
cmake ..
make
cpack
```

## Debug

### USB idenifiers

New USB device found, idVendor=16d0, idProduct=087e, bcdDevice= 1.00
New USB device strings: Mfr=1, Product=2, SerialNumber=0
Product: Digispark Serial
Manufacturer: digistump.com
